<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf8"/>
        <title>Jaxer 留言板</title>
        <script language=JavaScript type=text/javascript src=jquery.js>
        </script>
        <script runat=server>
            
            function GetDataDB(pageindex){
                var para = new Array();
                para[0] = pageindex;
                var rs = DBConn().execute("Select * from message order by oid desc limit (?-1)*10,10", para);
                var clomnus = new Array();
                clomnus[0] = "name";
                clomnus[1] = "content";
                clomnus[2] = "addTime";
                return rs.extractColumns(clomnus);
            }
            
            function InsertMessageDB(name, content){
                var para = new Array();
                para[0] = unescape(name);
                para[1] = unescape(content);
				Jaxer.Log.info(para[1]);
                DBConn().execute("insert into message values(?,?,datetime('now','localtime'))", para);
            }
            
            function DBConn(){
                return new Jaxer.DB.SQLite.Connection({
                    PATH: "message.db3"
                });
            }
        </script>
        <script runat=server-proxy>
            function GetData(pageindex){
                return GetDataDB(pageindex);
            }
            
            function InsertMessage(name, content){
                InsertMessageDB(name, content.replace(/ /g,"&nbsp;").replace(/\n/g,"<br />"));
            }
        </script>
        <script language=javascript>
            var currentPage = 1;
            $(function(){
            
                bindData(currentPage);
                
                $("#button1").click(function(){
                    var name = $("#txtName").val();
                    var content = $("#txtContent").val();
                    if (name != "" && content != "") {
                        InsertMessage(escape(name), escape(content));
                        currentPage = 1;
                        bindData(currentPage);
						$("#txtName").val("");
						$("#txtContent").val("");
                    }
					else
					{
						alert("请输入名字和内容。")
					}
                });
                
                $("#previous").click(function(){
                    currentPage = currentPage > 1 ? --currentPage : 1;
                    bindData(currentPage);
                });
                
                $("#next").click(function(){
                    currentPage++;
                    bindData(currentPage);
                });
            })
            function bindData(pageindex){
                var msgdatas = GetData(pageindex);
				$("[@id=ready]").remove();
                if (msgdatas.length > 0) {                    
                    $.each(msgdatas, function(i, n){
                        var row = $("#msgData").find("#template").clone();
                        row.find("#name").text(n.name);
                        row.find("#addTime").text(n.addTime);
                        row.find("#content").html(n.content);
                        row.attr("id", "ready");
                        row.appendTo($("#msgData"));
                    });
                    $("[@id=ready]").show();					
                }
				$("#pageInfo").html("第<b>"+currentPage+"</b>页");
            }
        </script>
    </head>
    <body>
        <table border=0 width=500 id=msgData>
            <tbody id=template style=display:none>
                <tr>
                    <td colspan=4 height=5>
                    </td>
                </tr>
                <tr>
                    <td>
                        姓名：
                    </td>
                    <td id=name>
                    </td>
                    <td>
                        留言时间：
                    </td>
                    <td id=addTime>
                    </td>
                </tr>
                <tr>
                    <td height=50 valign=top>
                        内容：
                    </td>
                    <td colspan=3 id=content valign=top>
                    </td>
                </tr>
                <tr>
                    <td colspan=4 height=2 bgcolor=black>
                    </td>
                </tr>
            </tbody>
        </table>
        <table border=0 width=500>
            <tr>
            	<td colspan=2 id=pageInfo></td>
                <td colspan=2 align=right>
                    <a href=javascript:void(0); id=previous>上一页</a>
                    <a href=javascript:void(0); id=next>下一页</a>
                </td>
            </tr>
        </table>
        <table>
            <tr>
                <td>
                    姓名：
                </td>
                <td>
                    <input type=text id=txtName>
                </td>
            </tr>
            <tr>
                <td>
                    内容：
                </td>
                <td>
                    <textarea id=txtContent cols=20 rows=5></textarea>
                </td>
            </tr>
            <tr>
                <td>
                    <input type=button id=button1 value=留言>
                </td>
            </tr>
        </table>
    </body>
</html>